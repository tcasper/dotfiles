"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const electron_1 = require("electron");
const fileUriToPath = require("file-uri-to-path");
const util_1 = require("../util");
const util_2 = require("./util");
class WebviewHandler {
    constructor(init) {
        this.emitter = new atom_1.Emitter();
        this.disposables = new atom_1.CompositeDisposable();
        this.destroyed = false;
        this.zoomLevel = 0;
        this.replyCallbacks = new Map();
        this.replyCallbackId = 0;
        this._element = document.createElement('webview');
        this._element.classList.add('markdown-preview-plus', 'native-key-bindings');
        this._element.disablewebsecurity = 'true';
        this._element.nodeintegration = 'true';
        this._element.src = `file:///${__dirname}/../../client/template.html`;
        this._element.style.width = '100%';
        this._element.style.height = '100%';
        this._element.addEventListener('ipc-message', (e) => {
            switch (e.channel) {
                case 'zoom-in':
                    this.zoomIn();
                    break;
                case 'zoom-out':
                    this.zoomOut();
                    break;
                case 'did-scroll-preview':
                    this.emitter.emit('did-scroll-preview', e.args[0]);
                    break;
                case 'uncaught-error': {
                    const err = e.args[0];
                    const newErr = new Error();
                    atom.notifications.addFatalError(`Uncaught error ${err.name} in markdown-preview-plus webview client`, {
                        dismissable: true,
                        stack: newErr.stack,
                        detail: `${err.message}\n\nstack:\n${err.stack}`,
                    });
                    break;
                }
                case 'request-reply': {
                    const { id, request, result } = e.args[0];
                    const cb = this.replyCallbacks.get(id);
                    if (cb && request === cb.request) {
                        const callback = cb.callback;
                        callback(result);
                    }
                    break;
                }
            }
        });
        this._element.addEventListener('will-navigate', async (e) => {
            const exts = util_1.atomConfig().previewConfig.shellOpenFileExtensions;
            const forceOpenExternal = exts.some((ext) => e.url.toLowerCase().endsWith(`.${ext.toLowerCase()}`));
            if (e.url.startsWith('file://') && !forceOpenExternal) {
                util_1.handlePromise(atom.workspace.open(fileUriToPath(e.url)));
            }
            else {
                electron_1.shell.openExternal(e.url);
            }
        });
        this.disposables.add(atom.styles.onDidAddStyleElement(() => {
            this.updateStyles();
        }), atom.styles.onDidRemoveStyleElement(() => {
            this.updateStyles();
        }), atom.styles.onDidUpdateStyleElement(() => {
            this.updateStyles();
        }));
        const onload = () => {
            if (this.destroyed)
                return;
            this._element.setZoomLevel(this.zoomLevel);
            this.updateStyles();
            init();
        };
        this._element.addEventListener('dom-ready', onload);
    }
    get element() {
        return this._element;
    }
    async runJS(js) {
        return new Promise((resolve) => this._element.executeJavaScript(js, false, resolve));
    }
    destroy() {
        if (this.destroyed)
            return;
        this.destroyed = true;
        this.disposables.dispose();
        this._element.remove();
    }
    async update(html, renderLaTeX) {
        if (this.destroyed)
            return undefined;
        return this.runRequest('update-preview', {
            html,
            renderLaTeX,
        });
    }
    setSourceMap(map) {
        this._element.send('set-source-map', { map });
    }
    setBasePath(path) {
        this._element.send('set-base-path', { path });
    }
    init(params) {
        this._element.send('init', params);
    }
    updateImages(oldSource, version) {
        this._element.send('update-images', {
            oldsrc: oldSource,
            v: version,
        });
    }
    async printToPDF(opts) {
        return new Promise((resolve, reject) => {
            this._element.printToPDF(opts, (error, data) => {
                if (error) {
                    reject(error);
                    return;
                }
                resolve(data);
            });
        });
    }
    sync(line, flash) {
        this._element.send('sync', { line, flash });
    }
    async syncSource() {
        return this.runRequest('sync-source', {});
    }
    scrollSync(firstLine, lastLine) {
        this._element.send('scroll-sync', { firstLine, lastLine });
    }
    zoomIn() {
        this.zoomLevel += 0.1;
        this._element.setZoomLevel(this.zoomLevel);
    }
    zoomOut() {
        this.zoomLevel -= 0.1;
        this._element.setZoomLevel(this.zoomLevel);
    }
    resetZoom() {
        this.zoomLevel = 0;
        this._element.setZoomLevel(this.zoomLevel);
    }
    print() {
        this._element.print();
    }
    openDevTools() {
        this._element.openDevTools();
    }
    async reload() {
        await this.runRequest('reload', {});
        this._element.reload();
    }
    error(msg) {
        this._element.send('error', { msg });
    }
    async getTeXConfig() {
        return this.runRequest('get-tex-config', {});
    }
    async getSelection() {
        return this.runRequest('get-selection', {});
    }
    updateStyles() {
        this._element.send('style', { styles: util_2.getPreviewStyles(true) });
    }
    async runRequest(request, args) {
        const id = this.replyCallbackId++;
        return new Promise((resolve) => {
            this.replyCallbacks.set(id, {
                request: request,
                callback: (result) => {
                    this.replyCallbacks.delete(id);
                    resolve(result);
                },
            });
            const newargs = Object.assign({ id }, args);
            this._element.send(request, newargs);
        });
    }
}
exports.WebviewHandler = WebviewHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2Vidmlldy1oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL21hcmtkb3duLXByZXZpZXctdmlldy93ZWJ2aWV3LWhhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBbUQ7QUFDbkQsdUNBQTRDO0FBQzVDLGtEQUFrRDtBQUVsRCxrQ0FBbUQ7QUFFbkQsaUNBQXlDO0FBMkN6QyxNQUFhLGNBQWM7SUFjekIsWUFBWSxJQUFnQjtRQWJaLFlBQU8sR0FBRyxJQUFJLGNBQU8sRUFLbEMsQ0FBQTtRQUNPLGdCQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBRXpDLGNBQVMsR0FBRyxLQUFLLENBQUE7UUFDakIsY0FBUyxHQUFHLENBQUMsQ0FBQTtRQUNiLG1CQUFjLEdBQUcsSUFBSSxHQUFHLEVBQStCLENBQUE7UUFDdkQsb0JBQWUsR0FBRyxDQUFDLENBQUE7UUFHekIsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQ2pELElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsRUFBRSxxQkFBcUIsQ0FBQyxDQUFBO1FBQzNFLElBQUksQ0FBQyxRQUFRLENBQUMsa0JBQWtCLEdBQUcsTUFBTSxDQUFBO1FBQ3pDLElBQUksQ0FBQyxRQUFRLENBQUMsZUFBZSxHQUFHLE1BQU0sQ0FBQTtRQUN0QyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsR0FBRyxXQUFXLFNBQVMsNkJBQTZCLENBQUE7UUFDckUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQTtRQUNsQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFBO1FBQ25DLElBQUksQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQzVCLGFBQWEsRUFDYixDQUFDLENBQWlDLEVBQUUs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QUFZO1FBQ3ZCLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLENBQUMsQ0FBQTtJQUM5QyxDQUFDO0lBRU0sS0FBSyxDQUFDLFlBQVk7UUFDdkIsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLGVBQWUsRUFBRSxFQUFFLENBQUMsQ0FBQTtJQUM3QyxDQUFDO0lBRU0sWUFBWTtRQUNqQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBVSxPQUFPLEVBQUUsRUFBRSxNQUFNLEVBQUUsdUJBQWdCLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFBO0lBQzFFLENBQUM7SUFFUyxLQUFLLENBQUMsVUFBVSxDQUN4QixPQUFVLEVBQ1YsSUFBcUU7UUFFckUsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFBO1FBQ2pDLE9BQU8sSUFBSSxPQUFPLENBQXFCLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDakQsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFO2dCQUMxQixPQUFPLEVBQUUsT0FBTztnQkFDaEIsUUFBUSxFQUFFLENBQUMsTUFBMEIsRUFBRSxFQUFFO29CQUN2QyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQTtvQkFDOUIsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO2dCQUNqQixDQUFDO2FBQ3dCLENBQUMsQ0FBQTtZQUM1QixNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUE7WUFDM0MsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUksT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFBO1FBQ3pDLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztDQUNGO0FBcE9ELHdDQW9PQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVtaXR0ZXIsIENvbXBvc2l0ZURpc3Bvc2FibGUgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgV2Vidmlld1RhZywgc2hlbGwgfSBmcm9tICdlbGVjdHJvbidcbmltcG9ydCBmaWxlVXJpVG9QYXRoID0gcmVxdWlyZSgnZmlsZS11cmktdG8tcGF0aCcpXG5cbmltcG9ydCB7IGhhbmRsZVByb21pc2UsIGF0b21Db25maWcgfSBmcm9tICcuLi91dGlsJ1xuaW1wb3J0IHsgUmVxdWVzdFJlcGx5TWFwLCBDaGFubmVsTWFwIH0gZnJvbSAnLi4vLi4vc3JjLWNsaWVudC9pcGMnXG5pbXBvcnQgeyBnZXRQcmV2aWV3U3R5bGVzIH0gZnJvbSAnLi91dGlsJ1xuXG5leHBvcnQgdHlwZSBSZXBseUNhbGxiYWNrU3RydWN0PFxuICBUIGV4dGVuZHMga2V5b2YgUmVxdWVzdFJlcGx5TWFwID0ga2V5b2YgUmVxdWVzdFJlcGx5TWFwXG4+ID0ge1xuICBbSyBpbiBrZXlvZiBSZXF1ZXN0UmVwbHlNYXBdOiB7XG4gICAgcmVxdWVzdDogS1xuICAgIGNhbGxiYWNrOiAocmVwbHk6IFJlcXVlc3RSZXBseU1hcFtLXSkgPT4gdm9pZFxuICB9XG59W1RdXG5cbmludGVyZmFjZSBQcmludFRvUERGT3B0aW9uc1JlYWwge1xuICAvKipcbiAgICogU3BlY2lmaWVzIHRoZSB0eXBlIG9mIG1hcmdpbnMgdG8gdXNlLiBVc2VzIDAgZm9yIGRlZmF1bHQgbWFyZ2luLCAxIGZvciBub1xuICAgKiBtYXJnaW4sIGFuZCAyIGZvciBtaW5pbXVtIG1hcmdpbi5cbiAgICovXG4gIG1hcmdpbnNUeXBlPzogbnVtYmVyXG4gIC8qKlxuICAgKiBTcGVjaWZ5IHBhZ2Ugc2l6ZSBvZiB0aGUgZ2VuZXJhdGVkIFBERi4gQ2FuIGJlIEEzLCBBNCwgQTUsIExlZ2FsLCBMZXR0ZXIsXG4gICAqIFRhYmxvaWQgb3IgYW4gT2JqZWN0IGNvbnRhaW5pbmcgaGVpZ2h0IGFuZCB3aWR0aCBpbiBtaWNyb25zLlxuICAgKi9cbiAgcGFnZVNpemU/OlxuICAgIHwgeyB3aWR0aDogbnVtYmVyOyBoZWlnaHQ6IG51bWJlciB9XG4gICAgfCAnQTMnXG4gICAgfCAnQTQnXG4gICAgfCAnQTUnXG4gICAgfCAnTGVnYWwnXG4gICAgfCAnTGV0dGVyJ1xuICAgIHwgJ1RhYmxvaWQnXG4gIC8qKlxuICAgKiBXaGV0aGVyIHRvIHByaW50IENTUyBiYWNrZ3JvdW5kcy5cbiAgICovXG4gIHByaW50QmFja2dyb3VuZD86IGJvb2xlYW5cbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gcHJpbnQgc2VsZWN0aW9uIG9ubHkuXG4gICAqL1xuICBwcmludFNlbGVjdGlvbk9ubHk/OiBib29sZWFuXG4gIC8qKlxuICAgKiB0cnVlIGZvciBsYW5kc2NhcGUsIGZhbHNlIGZvciBwb3J0cmFpdC5cbiAgICovXG4gIGxhbmRzY2FwZT86IGJvb2xlYW5cbn1cblxuZXhwb3J0IGNsYXNzIFdlYnZpZXdIYW5kbGVyIHtcbiAgcHVibGljIHJlYWRvbmx5IGVtaXR0ZXIgPSBuZXcgRW1pdHRlcjxcbiAgICB7fSxcbiAgICB7XG4gICAgICAnZGlkLXNjcm9sbC1wcmV2aWV3JzogeyBtaW46IG51bWJlcjsgbWF4OiBudW1iZXIgfVxuICAgIH1cbiAgPigpXG4gIHByb3RlY3RlZCBkaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgcHJpdmF0ZSByZWFkb25seSBfZWxlbWVudDogV2Vidmlld1RhZ1xuICBwcml2YXRlIGRlc3Ryb3llZCA9IGZhbHNlXG4gIHByaXZhdGUgem9vbUxldmVsID0gMFxuICBwcml2YXRlIHJlcGx5Q2FsbGJhY2tzID0gbmV3IE1hcDxudW1iZXIsIFJlcGx5Q2FsbGJhY2tTdHJ1Y3Q+KClcbiAgcHJpdmF0ZSByZXBseUNhbGxiYWNrSWQgPSAwXG5cbiAgY29uc3RydWN0b3IoaW5pdDogKCkgPT4gdm9pZCkge1xuICAgIHRoaXMuX2VsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd3ZWJ2aWV3JylcbiAgICB0aGlzLl9lbGVtZW50LmNsYXNzTGlzdC5hZGQoJ21hcmtkb3duLXByZXZpZXctcGx1cycsICduYXRpdmUta2V5LWJpbmRpbmdzJylcbiAgICB0aGlzLl9lbGVtZW50LmRpc2FibGV3ZWJzZWN1cml0eSA9ICd0cnVlJ1xuICAgIHRoaXMuX2VsZW1lbnQubm9kZWludGVncmF0aW9uID0gJ3RydWUnXG4gICAgdGhpcy5fZWxlbWVudC5zcmMgPSBgZmlsZTovLy8ke19fZGlybmFtZX0vLi4vLi4vY2xpZW50L3RlbXBsYXRlLmh0bWxgXG4gICAgdGhpcy5fZWxlbWVudC5zdHlsZS53aWR0aCA9ICcxMDAlJ1xuICAgIHRoaXMuX2VsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gJzEwMCUnXG4gICAgdGhpcy5fZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFxuICAgICAgJ2lwYy1tZXNzYWdlJyxcbiAgICAgIChlOiBFbGVjdHJvbi5JcGNNZXNzYWdlRXZlbnRDdXN0b20pID0+IHtcbiAgICAgICAgc3dpdGNoIChlLmNoYW5uZWwpIHtcbiAgICAgICAgICBjYXNlICd6b29tLWluJzpcbiAgICAgICAgICAgIHRoaXMuem9vbUluKClcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgY2FzZSAnem9vbS1vdXQnOlxuICAgICAgICAgICAgdGhpcy56b29tT3V0KClcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgY2FzZSAnZGlkLXNjcm9sbC1wcmV2aWV3JzpcbiAgICAgICAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtc2Nyb2xsLXByZXZpZXcnLCBlLmFyZ3NbMF0pXG4gICAgICAgICAgICBicmVha1xuICAgICAgICAgIGNhc2UgJ3VuY2F1Z2h0LWVycm9yJzoge1xuICAgICAgICAgICAgY29uc3QgZXJyID0gZS5hcmdzWzBdXG4gICAgICAgICAgICBjb25zdCBuZXdFcnIgPSBuZXcgRXJyb3IoKVxuICAgICAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEZhdGFsRXJyb3IoXG4gICAgICAgICAgICAgIGBVbmNhdWdodCBlcnJvciAke1xuICAgICAgICAgICAgICAgIGVyci5uYW1lXG4gICAgICAgICAgICAgIH0gaW4gbWFya2Rvd24tcHJldmlldy1wbHVzIHdlYnZpZXcgY2xpZW50YCxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHN0YWNrOiBuZXdFcnIuc3RhY2ssXG4gICAgICAgICAgICAgICAgZGV0YWlsOiBgJHtlcnIubWVzc2FnZX1cXG5cXG5zdGFjazpcXG4ke2Vyci5zdGFja31gLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICB9XG4gICAgICAgICAgLy8gcmVwbGllc1xuICAgICAgICAgIGNhc2UgJ3JlcXVlc3QtcmVwbHknOiB7XG4gICAgICAgICAgICBjb25zdCB7IGlkLCByZXF1ZXN0LCByZXN1bHQgfSA9IGUuYXJnc1swXVxuICAgICAgICAgICAgY29uc3QgY2IgPSB0aGlzLnJlcGx5Q2FsbGJhY2tzLmdldChpZClcbiAgICAgICAgICAgIGlmIChjYiAmJiByZXF1ZXN0ID09PSBjYi5yZXF1ZXN0KSB7XG4gICAgICAgICAgICAgIGNvbnN0IGNhbGxiYWNrOiAocjogYW55KSA9PiB2b2lkID0gY2IuY2FsbGJhY2tcbiAgICAgICAgICAgICAgY2FsbGJhY2socmVzdWx0KVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgKVxuICAgIHRoaXMuX2VsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignd2lsbC1uYXZpZ2F0ZScsIGFzeW5jIChlKSA9PiB7XG4gICAgICBjb25zdCBleHRzID0gYXRvbUNvbmZpZygpLnByZXZpZXdDb25maWcuc2hlbGxPcGVuRmlsZUV4dGVuc2lvbnNcbiAgICAgIGNvbnN0IGZvcmNlT3BlbkV4dGVybmFsID0gZXh0cy5zb21lKChleHQpID0+XG4gICAgICAgIGUudXJsLnRvTG93ZXJDYXNlKCkuZW5kc1dpdGgoYC4ke2V4dC50b0xvd2VyQ2FzZSgpfWApLFxuICAgICAgKVxuICAgICAgaWYgKGUudXJsLnN0YXJ0c1dpdGgoJ2ZpbGU6Ly8nKSAmJiAhZm9yY2VPcGVuRXh0ZXJuYWwpIHtcbiAgICAgICAgaGFuZGxlUHJvbWlzZShhdG9tLndvcmtzcGFjZS5vcGVuKGZpbGVVcmlUb1BhdGgoZS51cmwpKSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNoZWxsLm9wZW5FeHRlcm5hbChlLnVybClcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICBhdG9tLnN0eWxlcy5vbkRpZEFkZFN0eWxlRWxlbWVudCgoKSA9PiB7XG4gICAgICAgIHRoaXMudXBkYXRlU3R5bGVzKClcbiAgICAgIH0pLFxuICAgICAgYXRvbS5zdHlsZXMub25EaWRSZW1vdmVTdHlsZUVsZW1lbnQoKCkgPT4ge1xuICAgICAgICB0aGlzLnVwZGF0ZVN0eWxlcygpXG4gICAgICB9KSxcbiAgICAgIGF0b20uc3R5bGVzLm9uRGlkVXBkYXRlU3R5bGVFbGVtZW50KCgpID0+IHtcbiAgICAgICAgdGhpcy51cGRhdGVTdHlsZXMoKVxuICAgICAgfSksXG4gICAgKVxuXG4gICAgY29uc3Qgb25sb2FkID0gKCkgPT4ge1xuICAgICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm5cbiAgICAgIHRoaXMuX2VsZW1lbnQuc2V0Wm9vbUxldmVsKHRoaXMuem9vbUxldmVsKVxuICAgICAgdGhpcy51cGRhdGVTdHlsZXMoKVxuICAgICAgaW5pdCgpXG4gICAgfVxuICAgIHRoaXMuX2VsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZG9tLXJlYWR5Jywgb25sb2FkKVxuICB9XG5cbiAgcHVibGljIGdldCBlbGVtZW50KCk6IEhUTUxFbGVtZW50IHtcbiAgICByZXR1cm4gdGhpcy5fZWxlbWVudFxuICB9XG5cbiAgcHVibGljIGFzeW5jIHJ1bkpTPFQ+KGpzOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8VD4oKHJlc29sdmUpID0+XG4gICAgICB0aGlzLl9lbGVtZW50LmV4ZWN1dGVKYXZhU2NyaXB0KGpzLCBmYWxzZSwgcmVzb2x2ZSksXG4gICAgKVxuICB9XG5cbiAgcHVibGljIGRlc3Ryb3koKSB7XG4gICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm5cbiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWVcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICAgIHRoaXMuX2VsZW1lbnQucmVtb3ZlKClcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB1cGRhdGUoaHRtbDogc3RyaW5nLCByZW5kZXJMYVRlWDogYm9vbGVhbikge1xuICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuIHVuZGVmaW5lZFxuICAgIHJldHVybiB0aGlzLnJ1blJlcXVlc3QoJ3VwZGF0ZS1wcmV2aWV3Jywge1xuICAgICAgaHRtbCxcbiAgICAgIHJlbmRlckxhVGVYLFxuICAgIH0pXG4gIH1cblxuICBwdWJsaWMgc2V0U291cmNlTWFwKG1hcDoge1xuICAgIFtsaW5lOiBudW1iZXJdOiB7IHRhZzogc3RyaW5nOyBpbmRleDogbnVtYmVyIH1bXVxuICB9KSB7XG4gICAgdGhpcy5fZWxlbWVudC5zZW5kPCdzZXQtc291cmNlLW1hcCc+KCdzZXQtc291cmNlLW1hcCcsIHsgbWFwIH0pXG4gIH1cblxuICBwdWJsaWMgc2V0QmFzZVBhdGgocGF0aD86IHN0cmluZykge1xuICAgIHRoaXMuX2VsZW1lbnQuc2VuZDwnc2V0LWJhc2UtcGF0aCc+KCdzZXQtYmFzZS1wYXRoJywgeyBwYXRoIH0pXG4gIH1cblxuICBwdWJsaWMgaW5pdChwYXJhbXM6IENoYW5uZWxNYXBbJ2luaXQnXSkge1xuICAgIHRoaXMuX2VsZW1lbnQuc2VuZDwnaW5pdCc+KCdpbml0JywgcGFyYW1zKVxuICB9XG5cbiAgcHVibGljIHVwZGF0ZUltYWdlcyhvbGRTb3VyY2U6IHN0cmluZywgdmVyc2lvbjogbnVtYmVyIHwgdW5kZWZpbmVkKSB7XG4gICAgdGhpcy5fZWxlbWVudC5zZW5kPCd1cGRhdGUtaW1hZ2VzJz4oJ3VwZGF0ZS1pbWFnZXMnLCB7XG4gICAgICBvbGRzcmM6IG9sZFNvdXJjZSxcbiAgICAgIHY6IHZlcnNpb24sXG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBwcmludFRvUERGKG9wdHM6IFByaW50VG9QREZPcHRpb25zUmVhbCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxCdWZmZXI+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIC8vIFRPRE86IENvbXBsYWluIG9uIEVsZWN0cm9uXG4gICAgICB0aGlzLl9lbGVtZW50LnByaW50VG9QREYob3B0cyBhcyBhbnksIChlcnJvciwgZGF0YSkgPT4ge1xuICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICByZWplY3QoZXJyb3IpXG4gICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cbiAgICAgICAgcmVzb2x2ZShkYXRhKVxuICAgICAgfSlcbiAgICB9KVxuICB9XG5cbiAgcHVibGljIHN5bmMobGluZTogbnVtYmVyLCBmbGFzaDogYm9vbGVhbikge1xuICAgIHRoaXMuX2VsZW1lbnQuc2VuZDwnc3luYyc+KCdzeW5jJywgeyBsaW5lLCBmbGFzaCB9KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHN5bmNTb3VyY2UoKSB7XG4gICAgcmV0dXJuIHRoaXMucnVuUmVxdWVzdCgnc3luYy1zb3VyY2UnLCB7fSlcbiAgfVxuXG4gIHB1YmxpYyBzY3JvbGxTeW5jKGZpcnN0TGluZTogbnVtYmVyLCBsYXN0TGluZTogbnVtYmVyKSB7XG4gICAgdGhpcy5fZWxlbWVudC5zZW5kPCdzY3JvbGwtc3luYyc+KCdzY3JvbGwtc3luYycsIHsgZmlyc3RMaW5lLCBsYXN0TGluZSB9KVxuICB9XG5cbiAgcHVibGljIHpvb21JbigpIHtcbiAgICB0aGlzLnpvb21MZXZlbCArPSAwLjFcbiAgICB0aGlzLl9lbGVtZW50LnNldFpvb21MZXZlbCh0aGlzLnpvb21MZXZlbClcbiAgfVxuXG4gIHB1YmxpYyB6b29tT3V0KCkge1xuICAgIHRoaXMuem9vbUxldmVsIC09IDAuMVxuICAgIHRoaXMuX2VsZW1lbnQuc2V0Wm9vbUxldmVsKHRoaXMuem9vbUxldmVsKVxuICB9XG5cbiAgcHVibGljIHJlc2V0Wm9vbSgpIHtcbiAgICB0aGlzLnpvb21MZXZlbCA9IDBcbiAgICB0aGlzLl9lbGVtZW50LnNldFpvb21MZXZlbCh0aGlzLnpvb21MZXZlbClcbiAgfVxuXG4gIHB1YmxpYyBwcmludCgpIHtcbiAgICB0aGlzLl9lbGVtZW50LnByaW50KClcbiAgfVxuXG4gIHB1YmxpYyBvcGVuRGV2VG9vbHMoKSB7XG4gICAgdGhpcy5fZWxlbWVudC5vcGVuRGV2VG9vbHMoKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlbG9hZCgpIHtcbiAgICBhd2FpdCB0aGlzLnJ1blJlcXVlc3QoJ3JlbG9hZCcsIHt9KVxuICAgIHRoaXMuX2VsZW1lbnQucmVsb2FkKClcbiAgfVxuXG4gIHB1YmxpYyBlcnJvcihtc2c6IHN0cmluZykge1xuICAgIHRoaXMuX2VsZW1lbnQuc2VuZDwnZXJyb3InPignZXJyb3InLCB7IG1zZyB9KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldFRlWENvbmZpZygpIHtcbiAgICByZXR1cm4gdGhpcy5ydW5SZXF1ZXN0KCdnZXQtdGV4LWNvbmZpZycsIHt9KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldFNlbGVjdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5ydW5SZXF1ZXN0KCdnZXQtc2VsZWN0aW9uJywge30pXG4gIH1cblxuICBwdWJsaWMgdXBkYXRlU3R5bGVzKCkge1xuICAgIHRoaXMuX2VsZW1lbnQuc2VuZDwnc3R5bGUnPignc3R5bGUnLCB7IHN0eWxlczogZ2V0UHJldmlld1N0eWxlcyh0cnVlKSB9KVxuICB9XG5cbiAgcHJvdGVjdGVkIGFzeW5jIHJ1blJlcXVlc3Q8VCBleHRlbmRzIGtleW9mIFJlcXVlc3RSZXBseU1hcD4oXG4gICAgcmVxdWVzdDogVCxcbiAgICBhcmdzOiB7IFtLIGluIEV4Y2x1ZGU8a2V5b2YgQ2hhbm5lbE1hcFtUXSwgJ2lkJz5dOiBDaGFubmVsTWFwW1RdW0tdIH0sXG4gICkge1xuICAgIGNvbnN0IGlkID0gdGhpcy5yZXBseUNhbGxiYWNrSWQrK1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxSZXF1ZXN0UmVwbHlNYXBbVF0+KChyZXNvbHZlKSA9PiB7XG4gICAgICB0aGlzLnJlcGx5Q2FsbGJhY2tzLnNldChpZCwge1xuICAgICAgICByZXF1ZXN0OiByZXF1ZXN0LFxuICAgICAgICBjYWxsYmFjazogKHJlc3VsdDogUmVxdWVzdFJlcGx5TWFwW1RdKSA9PiB7XG4gICAgICAgICAgdGhpcy5yZXBseUNhbGxiYWNrcy5kZWxldGUoaWQpXG4gICAgICAgICAgcmVzb2x2ZShyZXN1bHQpXG4gICAgICAgIH0sXG4gICAgICB9IGFzIFJlcGx5Q2FsbGJhY2tTdHJ1Y3Q8VD4pXG4gICAgICBjb25zdCBuZXdhcmdzID0gT2JqZWN0LmFzc2lnbih7IGlkIH0sIGFyZ3MpXG4gICAgICB0aGlzLl9lbGVtZW50LnNlbmQ8VD4ocmVxdWVzdCwgbmV3YXJncylcbiAgICB9KVxuICB9XG59XG4iXX0=