"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const pandocHelper = require("./pandoc-helper");
const markdownIt = require("./markdown-it-helper");
const extension_helper_1 = require("./extension-helper");
const atom_1 = require("atom");
const util_1 = require("./util");
const util_common_1 = require("./util-common");
const { resourcePath } = atom.getLoadSettings();
const packagePath = path.dirname(__dirname);
async function render(options) {
    const text = options.text.replace(/^\s*<!doctype(\s+.*)?>\s*/i, '');
    let html;
    let error;
    if (util_1.atomConfig().renderer === 'pandoc') {
        try {
            html = await pandocHelper.renderPandoc(text, options.filePath, options.renderLaTeX);
        }
        catch (err) {
            const e = err;
            if (e.html === undefined)
                throw e;
            error = e.message;
            html = e.html;
        }
    }
    else {
        html = markdownIt.render(text, options.renderLaTeX);
    }
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    sanitize(doc);
    if (options.mode === 'normal') {
        if (options.imageWatcher)
            options.imageWatcher.clear();
        resolveImagePaths(doc, options.filePath, false, undefined, options.imageWatcher);
    }
    else {
        switch (options.mode) {
            case 'save':
                handleImages({
                    doc,
                    filePath: options.filePath,
                    savePath: options.savePath,
                    behaviour: util_1.atomConfig().saveConfig.mediaOnSaveAsHTMLBehaviour,
                });
                break;
            case 'copy':
                handleImages({
                    doc,
                    filePath: options.filePath,
                    behaviour: util_1.atomConfig().saveConfig.mediaOnCopyAsHTMLBehaviour,
                });
                break;
            default:
                throw invalidMode(options);
        }
    }
    let defaultCodeLanguage = 'text';
    if ((options.grammar && options.grammar.scopeName) === 'source.litcoffee') {
        defaultCodeLanguage = 'coffee';
    }
    if (!(util_1.atomConfig().renderer === 'pandoc' &&
        util_1.atomConfig().pandocConfig.useNativePandocCodeStyles)) {
        await highlightCodeBlocks(doc, defaultCodeLanguage);
    }
    if (error) {
        const errd = doc.createElement('div');
        const msgel = doc.createElement('code');
        msgel.innerText = error;
        errd.innerHTML = `<h1>Pandoc Error:</h1>${msgel.outerHTML}<hr>`;
        doc.body.insertBefore(errd, doc.body.firstElementChild);
    }
    return doc;
}
exports.render = render;
function invalidMode(mode) {
    return new Error(`Invalid render mode ${JSON.stringify(mode)}`);
}
function sanitize(doc) {
    doc.querySelectorAll("script:not([type^='math/tex'])").forEach((elem) => {
        elem.remove();
    });
    const attributesToRemove = [
        'onabort',
        'onblur',
        'onchange',
        'onclick',
        'ondbclick',
        'onerror',
        'onfocus',
        'onkeydown',
        'onkeypress',
        'onkeyup',
        'onload',
        'onmousedown',
        'onmousemove',
        'onmouseover',
        'onmouseout',
        'onmouseup',
        'onreset',
        'onresize',
        'onscroll',
        'onselect',
        'onsubmit',
        'onunload',
    ];
    doc.querySelectorAll('*').forEach((elem) => attributesToRemove.map((attribute) => {
        elem.removeAttribute(attribute);
    }));
}
function handleImages(opts) {
    const relativize = opts.behaviour === 'relativized';
    switch (opts.behaviour) {
        case 'relativized':
        case 'absolutized':
            resolveImagePaths(opts.doc, opts.filePath, relativize, opts.savePath);
            break;
        case 'untouched':
    }
}
function resolveImagePaths(doc, filePath, relativize, savePath, imageWatcher) {
    const [rootDirectory] = atom.project.relativizePath(filePath || '');
    const media = util_common_1.getMedia(doc);
    Array.from(media).map(function (img) {
        let attrName;
        if (img.tagName === 'LINK')
            attrName = 'href';
        else
            attrName = 'src';
        let src = img.getAttribute(attrName);
        if (src) {
            if (util_1.atomConfig().renderer !== 'pandoc') {
                src = decodeURI(src);
            }
            if (src.match(/^(https?|atom|data):/)) {
                return;
            }
            if (process.resourcesPath && src.startsWith(process.resourcesPath)) {
                return;
            }
            if (src.startsWith(resourcePath)) {
                return;
            }
            if (src.startsWith(packagePath)) {
                return;
            }
            if (src[0] === '/') {
                if (!util_1.isFileSync(src)) {
                    try {
                        if (rootDirectory !== null) {
                            src = path.join(rootDirectory, src.substring(1));
                        }
                    }
                    catch (e) {
                    }
                }
            }
            else if (filePath) {
                src = path.resolve(path.dirname(filePath), src);
            }
            if (relativize && (filePath !== undefined || savePath !== undefined)) {
                const fp = savePath !== undefined ? savePath : filePath;
                src = path.relative(path.dirname(fp), src);
            }
            if (imageWatcher) {
                const v = imageWatcher.watch(src);
                if (v !== undefined)
                    src = `${src}?v=${v}`;
            }
            img[attrName] = src;
        }
    });
}
async function highlightCodeBlocks(domFragment, defaultLanguage) {
    const fontFamily = atom.config.get('editor.fontFamily');
    if (fontFamily) {
        for (const codeElement of Array.from(domFragment.querySelectorAll('code'))) {
            codeElement.style.fontFamily = fontFamily;
        }
    }
    await Promise.all(Array.from(domFragment.querySelectorAll('pre')).map(async (preElement) => {
        const codeBlock = preElement.firstElementChild !== null
            ? preElement.firstElementChild
            : preElement;
        const cbClass = codeBlock.className || preElement.className;
        const fenceName = cbClass
            ? cbClass.replace(/^(lang-|sourceCode )/, '')
            : defaultLanguage;
        const ctw = util_1.atomConfig().codeTabWidth;
        const ed = new atom_1.TextEditor({
            readonly: true,
            keyboardInputEnabled: false,
            showInvisibles: false,
            tabLength: ctw === 0 ? atom.config.get('editor.tabLength') : ctw,
        });
        const el = atom.views.getView(ed);
        try {
            el.setUpdatedSynchronously(true);
            el.style.pointerEvents = 'none';
            el.style.position = 'absolute';
            el.style.width = '0px';
            el.style.height = '1px';
            atom.views.getView(atom.workspace).appendChild(el);
            atom.grammars.assignLanguageMode(ed.getBuffer(), extension_helper_1.scopeForFenceName(fenceName));
            ed.setText(codeBlock.textContent.replace(/\r?\n$/, ''));
            await editorTokenized(ed);
            const html = Array.from(el.querySelectorAll('.line:not(.dummy)'));
            preElement.classList.add('editor-colors');
            preElement.innerHTML = html.map((x) => x.innerHTML).join('\n');
            if (fenceName)
                preElement.classList.add(`lang-${fenceName}`);
        }
        finally {
            el.remove();
        }
    }));
    return domFragment;
}
async function editorTokenized(editor) {
    return new Promise((resolve) => {
        if (editor.getBuffer().getLanguageMode().fullyTokenized) {
            resolve();
        }
        else {
            const disp = editor.onDidTokenize(() => {
                disp.dispose();
                resolve();
            });
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVuZGVyZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFDN0IsZ0RBQWdEO0FBQ2hELG1EQUFtRDtBQUNuRCx5REFBc0Q7QUFDdEQsK0JBQTBDO0FBQzFDLGlDQUErQztBQUMvQywrQ0FBd0M7QUFHeEMsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQTtBQUMvQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO0FBaUJwQyxLQUFLLFVBQVUsTUFBTSxDQUFDLE9BQXNCO0lBR2pELE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLDRCQUE0QixFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBRW5FLElBQUksSUFBSSxDQUFBO0lBQ1IsSUFBSSxLQUFLLENBQUE7SUFDVCxJQUFJLGlCQUFVLEVBQUUsQ0FBQyxRQUFRLEtBQUssUUFBUSxFQUFFO1FBQ3RDLElBQUk7WUFDRixJQUFJLEdBQUcsTUFBTSxZQUFZLENBQUMsWUFBWSxDQUNwQyxJQUFJLEVBQ0osT0FBTyxDQUFDLFFBQVEsRUFDaEIsT0FBTyxDQUFDLFdBQVcsQ0FDcEIsQ0FBQTtTQUNGO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDWixNQUFNLENBQUMsR0FBRyxHQUFnQyxDQUFBO1lBQzFDLElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxTQUFTO2dCQUFFLE1BQU0sQ0FBQyxDQUFBO1lBQ2pDLEtBQUssR0FBRyxDQUFDLENBQUMsT0FBaUIsQ0FBQTtZQUMzQixJQUFJLEdBQUcsQ0FBQyxDQUFDLElBQWMsQ0FBQTtTQUN4QjtLQUNGO1NBQU07UUFDTCxJQUFJLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFBO0tBQ3BEO0lBQ0Qs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QUcsTUFBTSxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUU7Z0JBQ3JDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQTtnQkFDZCxPQUFPLEVBQUUsQ0FBQTtZQUNYLENBQUMsQ0FBQyxDQUFBO1NBQ0g7SUFDSCxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuaW1wb3J0IHBhbmRvY0hlbHBlciA9IHJlcXVpcmUoJy4vcGFuZG9jLWhlbHBlcicpXG5pbXBvcnQgbWFya2Rvd25JdCA9IHJlcXVpcmUoJy4vbWFya2Rvd24taXQtaGVscGVyJykgLy8gRGVmZXIgdW50aWwgdXNlZFxuaW1wb3J0IHsgc2NvcGVGb3JGZW5jZU5hbWUgfSBmcm9tICcuL2V4dGVuc2lvbi1oZWxwZXInXG5pbXBvcnQgeyBHcmFtbWFyLCBUZXh0RWRpdG9yIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IGlzRmlsZVN5bmMsIGF0b21Db25maWcgfSBmcm9tICcuL3V0aWwnXG5pbXBvcnQgeyBnZXRNZWRpYSB9IGZyb20gJy4vdXRpbC1jb21tb24nXG5pbXBvcnQgeyBJbWFnZVdhdGNoZXIgfSBmcm9tICcuL2ltYWdlLXdhdGNoLWhlbHBlcidcblxuY29uc3QgeyByZXNvdXJjZVBhdGggfSA9IGF0b20uZ2V0TG9hZFNldHRpbmdzKClcbmNvbnN0IHBhY2thZ2VQYXRoID0gcGF0aC5kaXJuYW1lKF9fZGlybmFtZSlcblxuZXhwb3J0IHR5cGUgUmVuZGVyTW9kZSA9ICdub3JtYWwnIHwgJ2NvcHknIHwgJ3NhdmUnXG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29tbW9uUmVuZGVyT3B0aW9uczxUIGV4dGVuZHMgUmVuZGVyTW9kZT4ge1xuICB0ZXh0OiBzdHJpbmdcbiAgZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZFxuICBncmFtbWFyPzogR3JhbW1hclxuICByZW5kZXJMYVRlWDogYm9vbGVhblxuICBtb2RlOiBUXG59XG5cbmV4cG9ydCB0eXBlIFJlbmRlck9wdGlvbnMgPVxuICB8IChDb21tb25SZW5kZXJPcHRpb25zPCdub3JtYWwnPiAmIHsgaW1hZ2VXYXRjaGVyPzogSW1hZ2VXYXRjaGVyIH0pXG4gIHwgKENvbW1vblJlbmRlck9wdGlvbnM8J3NhdmUnPiAmIHsgc2F2ZVBhdGg6IHN0cmluZyB9KVxuICB8IChDb21tb25SZW5kZXJPcHRpb25zPCdjb3B5Jz4pXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZW5kZXIob3B0aW9uczogUmVuZGVyT3B0aW9ucyk6IFByb21pc2U8SFRNTERvY3VtZW50PiB7XG4gIC8vIFJlbW92ZSB0aGUgPCFkb2N0eXBlPiBzaW5jZSBvdGhlcndpc2UgbWFya2VkIHdpbGwgZXNjYXBlIGl0XG4gIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9jaGpqL21hcmtlZC9pc3N1ZXMvMzU0XG4gIGNvbnN0IHRleHQgPSBvcHRpb25zLnRleHQucmVwbGFjZSgvXlxccyo8IWRvY3R5cGUoXFxzKy4qKT8+XFxzKi9pLCAnJylcblxuICBsZXQgaHRtbFxuICBsZXQgZXJyb3JcbiAgaWYgKGF0b21Db25maWcoKS5yZW5kZXJlciA9PT0gJ3BhbmRvYycpIHtcbiAgICB0cnkge1xuICAgICAgaHRtbCA9IGF3YWl0IHBhbmRvY0hlbHBlci5yZW5kZXJQYW5kb2MoXG4gICAgICAgIHRleHQsXG4gICAgICAgIG9wdGlvbnMuZmlsZVBhdGgsXG4gICAgICAgIG9wdGlvbnMucmVuZGVyTGFUZVgsXG4gICAgICApXG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zdCBlID0gZXJyIGFzIEVycm9yICYgeyBodG1sPzogc3RyaW5nIH1cbiAgICAgIGlmIChlLmh0bWwgPT09IHVuZGVmaW5lZCkgdGhyb3cgZVxuICAgICAgZXJyb3IgPSBlLm1lc3NhZ2UgYXMgc3RyaW5nXG4gICAgICBodG1sID0gZS5odG1sIGFzIHN0cmluZ1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBodG1sID0gbWFya2Rvd25JdC5yZW5kZXIodGV4dCwgb3B0aW9ucy5yZW5kZXJMYVRlWClcbiAgfVxuICBjb25zdCBwYXJzZXIgPSBuZXcgRE9NUGFyc2VyKClcbiAgY29uc3QgZG9jID0gcGFyc2VyLnBhcnNlRnJvbVN0cmluZyhodG1sLCAndGV4dC9odG1sJylcbiAgc2FuaXRpemUoZG9jKVxuICBpZiAob3B0aW9ucy5tb2RlID09PSAnbm9ybWFsJykge1xuICAgIGlmIChvcHRpb25zLmltYWdlV2F0Y2hlcikgb3B0aW9ucy5pbWFnZVdhdGNoZXIuY2xlYXIoKVxuICAgIHJlc29sdmVJbWFnZVBhdGhzKFxuICAgICAgZG9jLFxuICAgICAgb3B0aW9ucy5maWxlUGF0aCxcbiAgICAgIGZhbHNlLFxuICAgICAgdW5kZWZpbmVkLFxuICAgICAgb3B0aW9ucy5pbWFnZVdhdGNoZXIsXG4gICAgKVxuICB9IGVsc2Uge1xuICAgIHN3aXRjaCAob3B0aW9ucy5tb2RlKSB7XG4gICAgICBjYXNlICdzYXZlJzpcbiAgICAgICAgaGFuZGxlSW1hZ2VzKHtcbiAgICAgICAgICBkb2MsXG4gICAgICAgICAgZmlsZVBhdGg6IG9wdGlvbnMuZmlsZVBhdGgsXG4gICAgICAgICAgc2F2ZVBhdGg6IG9wdGlvbnMuc2F2ZVBhdGgsXG4gICAgICAgICAgYmVoYXZpb3VyOiBhdG9tQ29uZmlnKCkuc2F2ZUNvbmZpZy5tZWRpYU9uU2F2ZUFzSFRNTEJlaGF2aW91cixcbiAgICAgICAgfSlcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgJ2NvcHknOlxuICAgICAgICBoYW5kbGVJbWFnZXMoe1xuICAgICAgICAgIGRvYyxcbiAgICAgICAgICBmaWxlUGF0aDogb3B0aW9ucy5maWxlUGF0aCxcbiAgICAgICAgICBiZWhhdmlvdXI6IGF0b21Db25maWcoKS5zYXZlQ29uZmlnLm1lZGlhT25Db3B5QXNIVE1MQmVoYXZpb3VyLFxuICAgICAgICB9KVxuICAgICAgICBicmVha1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgaW52YWxpZE1vZGUob3B0aW9ucylcbiAgICB9XG4gIH1cbiAgbGV0IGRlZmF1bHRDb2RlTGFuZ3VhZ2U6IHN0cmluZyA9ICd0ZXh0J1xuICAvLyBEZWZhdWx0IGNvZGUgYmxvY2tzIHRvIGJlIGNvZmZlZSBpbiBMaXRlcmF0ZSBDb2ZmZWVTY3JpcHQgZmlsZXNcbiAgaWYgKChvcHRpb25zLmdyYW1tYXIgJiYgb3B0aW9ucy5ncmFtbWFyLnNjb3BlTmFtZSkgPT09ICdzb3VyY2UubGl0Y29mZmVlJykge1xuICAgIGRlZmF1bHRDb2RlTGFuZ3VhZ2UgPSAnY29mZmVlJ1xuICB9XG4gIGlmIChcbiAgICAhKFxuICAgICAgYXRvbUNvbmZpZygpLnJlbmRlcmVyID09PSAncGFuZG9jJyAmJlxuICAgICAgYXRvbUNvbmZpZygpLnBhbmRvY0NvbmZpZy51c2VOYXRpdmVQYW5kb2NDb2RlU3R5bGVzXG4gICAgKVxuICApIHtcbiAgICBhd2FpdCBoaWdobGlnaHRDb2RlQmxvY2tzKGRvYywgZGVmYXVsdENvZGVMYW5ndWFnZSlcbiAgfVxuICBpZiAoZXJyb3IpIHtcbiAgICBjb25zdCBlcnJkID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gICAgY29uc3QgbXNnZWwgPSBkb2MuY3JlYXRlRWxlbWVudCgnY29kZScpXG4gICAgbXNnZWwuaW5uZXJUZXh0ID0gZXJyb3JcbiAgICBlcnJkLmlubmVySFRNTCA9IGA8aDE+UGFuZG9jIEVycm9yOjwvaDE+JHttc2dlbC5vdXRlckhUTUx9PGhyPmBcbiAgICBkb2MuYm9keS5pbnNlcnRCZWZvcmUoZXJyZCwgZG9jLmJvZHkuZmlyc3RFbGVtZW50Q2hpbGQpXG4gIH1cbiAgcmV0dXJuIGRvY1xufVxuXG5mdW5jdGlvbiBpbnZhbGlkTW9kZShtb2RlOiBuZXZlcikge1xuICByZXR1cm4gbmV3IEVycm9yKGBJbnZhbGlkIHJlbmRlciBtb2RlICR7SlNPTi5zdHJpbmdpZnkobW9kZSl9YClcbn1cblxuZnVuY3Rpb24gc2FuaXRpemUoZG9jOiBIVE1MRG9jdW1lbnQpIHtcbiAgLy8gRG8gbm90IHJlbW92ZSBNYXRoSmF4IHNjcmlwdCBkZWxpbWl0ZWQgYmxvY2tzXG4gIGRvYy5xdWVyeVNlbGVjdG9yQWxsKFwic2NyaXB0Om5vdChbdHlwZV49J21hdGgvdGV4J10pXCIpLmZvckVhY2goKGVsZW0pID0+IHtcbiAgICBlbGVtLnJlbW92ZSgpXG4gIH0pXG4gIGNvbnN0IGF0dHJpYnV0ZXNUb1JlbW92ZSA9IFtcbiAgICAnb25hYm9ydCcsXG4gICAgJ29uYmx1cicsXG4gICAgJ29uY2hhbmdlJyxcbiAgICAnb25jbGljaycsXG4gICAgJ29uZGJjbGljaycsXG4gICAgJ29uZXJyb3InLFxuICAgICdvbmZvY3VzJyxcbiAgICAnb25rZXlkb3duJyxcbiAgICAnb25rZXlwcmVzcycsXG4gICAgJ29ua2V5dXAnLFxuICAgICdvbmxvYWQnLFxuICAgICdvbm1vdXNlZG93bicsXG4gICAgJ29ubW91c2Vtb3ZlJyxcbiAgICAnb25tb3VzZW92ZXInLFxuICAgICdvbm1vdXNlb3V0JyxcbiAgICAnb25tb3VzZXVwJyxcbiAgICAnb25yZXNldCcsXG4gICAgJ29ucmVzaXplJyxcbiAgICAnb25zY3JvbGwnLFxuICAgICdvbnNlbGVjdCcsXG4gICAgJ29uc3VibWl0JyxcbiAgICAnb251bmxvYWQnLFxuICBdXG4gIGRvYy5xdWVyeVNlbGVjdG9yQWxsKCcqJykuZm9yRWFjaCgoZWxlbSkgPT5cbiAgICBhdHRyaWJ1dGVzVG9SZW1vdmUubWFwKChhdHRyaWJ1dGUpID0+IHtcbiAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZSlcbiAgICB9KSxcbiAgKVxufVxuXG5mdW5jdGlvbiBoYW5kbGVJbWFnZXMob3B0czoge1xuICBiZWhhdmlvdXI6ICdyZWxhdGl2aXplZCcgfCAnYWJzb2x1dGl6ZWQnIHwgJ3VudG91Y2hlZCdcbiAgZG9jOiBIVE1MRG9jdW1lbnRcbiAgZmlsZVBhdGg/OiBzdHJpbmdcbiAgc2F2ZVBhdGg/OiBzdHJpbmdcbn0pIHtcbiAgY29uc3QgcmVsYXRpdml6ZSA9IG9wdHMuYmVoYXZpb3VyID09PSAncmVsYXRpdml6ZWQnXG4gIHN3aXRjaCAob3B0cy5iZWhhdmlvdXIpIHtcbiAgICBjYXNlICdyZWxhdGl2aXplZCc6XG4gICAgY2FzZSAnYWJzb2x1dGl6ZWQnOlxuICAgICAgcmVzb2x2ZUltYWdlUGF0aHMob3B0cy5kb2MsIG9wdHMuZmlsZVBhdGgsIHJlbGF0aXZpemUsIG9wdHMuc2F2ZVBhdGgpXG4gICAgICBicmVha1xuICAgIGNhc2UgJ3VudG91Y2hlZCc6XG4gICAgLyogbm9vcCAqL1xuICB9XG59XG5cbmZ1bmN0aW9uIHJlc29sdmVJbWFnZVBhdGhzKFxuICBkb2M6IEhUTUxEb2N1bWVudCxcbiAgZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgcmVsYXRpdml6ZTogYm9vbGVhbixcbiAgc2F2ZVBhdGg/OiBzdHJpbmcsXG4gIGltYWdlV2F0Y2hlcj86IEltYWdlV2F0Y2hlcixcbikge1xuICBjb25zdCBbcm9vdERpcmVjdG9yeV0gPSBhdG9tLnByb2plY3QucmVsYXRpdml6ZVBhdGgoZmlsZVBhdGggfHwgJycpXG4gIGNvbnN0IG1lZGlhID0gZ2V0TWVkaWEoZG9jKVxuICBBcnJheS5mcm9tKG1lZGlhKS5tYXAoZnVuY3Rpb24oaW1nKSB7XG4gICAgbGV0IGF0dHJOYW1lOiAnaHJlZicgfCAnc3JjJ1xuICAgIGlmIChpbWcudGFnTmFtZSA9PT0gJ0xJTksnKSBhdHRyTmFtZSA9ICdocmVmJ1xuICAgIGVsc2UgYXR0ck5hbWUgPSAnc3JjJ1xuICAgIGxldCBzcmMgPSBpbWcuZ2V0QXR0cmlidXRlKGF0dHJOYW1lKVxuICAgIGlmIChzcmMpIHtcbiAgICAgIGlmIChhdG9tQ29uZmlnKCkucmVuZGVyZXIgIT09ICdwYW5kb2MnKSB7XG4gICAgICAgIHNyYyA9IGRlY29kZVVSSShzcmMpXG4gICAgICB9XG5cbiAgICAgIGlmIChzcmMubWF0Y2goL14oaHR0cHM/fGF0b218ZGF0YSk6LykpIHtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICBpZiAocHJvY2Vzcy5yZXNvdXJjZXNQYXRoICYmIHNyYy5zdGFydHNXaXRoKHByb2Nlc3MucmVzb3VyY2VzUGF0aCkpIHtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICBpZiAoc3JjLnN0YXJ0c1dpdGgocmVzb3VyY2VQYXRoKSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGlmIChzcmMuc3RhcnRzV2l0aChwYWNrYWdlUGF0aCkpIHtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG5cbiAgICAgIGlmIChzcmNbMF0gPT09ICcvJykge1xuICAgICAgICBpZiAoIWlzRmlsZVN5bmMoc3JjKSkge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAocm9vdERpcmVjdG9yeSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICBzcmMgPSBwYXRoLmpvaW4ocm9vdERpcmVjdG9yeSwgc3JjLnN1YnN0cmluZygxKSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAvLyBub29wXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGZpbGVQYXRoKSB7XG4gICAgICAgIHNyYyA9IHBhdGgucmVzb2x2ZShwYXRoLmRpcm5hbWUoZmlsZVBhdGgpLCBzcmMpXG4gICAgICB9XG5cbiAgICAgIGlmIChyZWxhdGl2aXplICYmIChmaWxlUGF0aCAhPT0gdW5kZWZpbmVkIHx8IHNhdmVQYXRoICE9PSB1bmRlZmluZWQpKSB7XG4gICAgICAgIGNvbnN0IGZwID0gc2F2ZVBhdGggIT09IHVuZGVmaW5lZCA/IHNhdmVQYXRoIDogZmlsZVBhdGghXG4gICAgICAgIHNyYyA9IHBhdGgucmVsYXRpdmUocGF0aC5kaXJuYW1lKGZwKSwgc3JjKVxuICAgICAgfVxuXG4gICAgICAvLyBXYXRjaCBpbWFnZSBmb3IgY2hhbmdlc1xuICAgICAgaWYgKGltYWdlV2F0Y2hlcikge1xuICAgICAgICBjb25zdCB2ID0gaW1hZ2VXYXRjaGVyLndhdGNoKHNyYylcbiAgICAgICAgaWYgKHYgIT09IHVuZGVmaW5lZCkgc3JjID0gYCR7c3JjfT92PSR7dn1gXG4gICAgICB9XG5cbiAgICAgIGltZ1thdHRyTmFtZV0gPSBzcmNcbiAgICB9XG4gIH0pXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGhpZ2hsaWdodENvZGVCbG9ja3MoXG4gIGRvbUZyYWdtZW50OiBEb2N1bWVudCxcbiAgZGVmYXVsdExhbmd1YWdlOiBzdHJpbmcsXG4pIHtcbiAgY29uc3QgZm9udEZhbWlseSA9IGF0b20uY29uZmlnLmdldCgnZWRpdG9yLmZvbnRGYW1pbHknKVxuICBpZiAoZm9udEZhbWlseSkge1xuICAgIGZvciAoY29uc3QgY29kZUVsZW1lbnQgb2YgQXJyYXkuZnJvbShcbiAgICAgIGRvbUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2NvZGUnKSxcbiAgICApKSB7XG4gICAgICBjb2RlRWxlbWVudC5zdHlsZS5mb250RmFtaWx5ID0gZm9udEZhbWlseVxuICAgIH1cbiAgfVxuXG4gIGF3YWl0IFByb21pc2UuYWxsKFxuICAgIEFycmF5LmZyb20oZG9tRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbCgncHJlJykpLm1hcChhc3luYyAocHJlRWxlbWVudCkgPT4ge1xuICAgICAgY29uc3QgY29kZUJsb2NrID1cbiAgICAgICAgcHJlRWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZCAhPT0gbnVsbFxuICAgICAgICAgID8gcHJlRWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZFxuICAgICAgICAgIDogcHJlRWxlbWVudFxuICAgICAgY29uc3QgY2JDbGFzcyA9IGNvZGVCbG9jay5jbGFzc05hbWUgfHwgcHJlRWxlbWVudC5jbGFzc05hbWVcbiAgICAgIGNvbnN0IGZlbmNlTmFtZSA9IGNiQ2xhc3NcbiAgICAgICAgPyBjYkNsYXNzLnJlcGxhY2UoL14obGFuZy18c291cmNlQ29kZSApLywgJycpXG4gICAgICAgIDogZGVmYXVsdExhbmd1YWdlXG5cbiAgICAgIGNvbnN0IGN0dyA9IGF0b21Db25maWcoKS5jb2RlVGFiV2lkdGhcbiAgICAgIGNvbnN0IGVkID0gbmV3IFRleHRFZGl0b3Ioe1xuICAgICAgICByZWFkb25seTogdHJ1ZSxcbiAgICAgICAga2V5Ym9hcmRJbnB1dEVuYWJsZWQ6IGZhbHNlLFxuICAgICAgICBzaG93SW52aXNpYmxlczogZmFsc2UsXG4gICAgICAgIHRhYkxlbmd0aDogY3R3ID09PSAwID8gYXRvbS5jb25maWcuZ2V0KCdlZGl0b3IudGFiTGVuZ3RoJykgOiBjdHcsXG4gICAgICB9KVxuICAgICAgY29uc3QgZWwgPSBhdG9tLnZpZXdzLmdldFZpZXcoZWQpXG4gICAgICB0cnkge1xuICAgICAgICBlbC5zZXRVcGRhdGVkU3luY2hyb25vdXNseSh0cnVlKVxuICAgICAgICBlbC5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ25vbmUnXG4gICAgICAgIGVsLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJ1xuICAgICAgICBlbC5zdHlsZS53aWR0aCA9ICcwcHgnXG4gICAgICAgIGVsLnN0eWxlLmhlaWdodCA9ICcxcHgnXG4gICAgICAgIGF0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZSkuYXBwZW5kQ2hpbGQoZWwpXG4gICAgICAgIGF0b20uZ3JhbW1hcnMuYXNzaWduTGFuZ3VhZ2VNb2RlKFxuICAgICAgICAgIGVkLmdldEJ1ZmZlcigpLFxuICAgICAgICAgIHNjb3BlRm9yRmVuY2VOYW1lKGZlbmNlTmFtZSksXG4gICAgICAgIClcbiAgICAgICAgZWQuc2V0VGV4dChjb2RlQmxvY2sudGV4dENvbnRlbnQhLnJlcGxhY2UoL1xccj9cXG4kLywgJycpKVxuICAgICAgICBhd2FpdCBlZGl0b3JUb2tlbml6ZWQoZWQpXG4gICAgICAgIGNvbnN0IGh0bWwgPSBBcnJheS5mcm9tKGVsLnF1ZXJ5U2VsZWN0b3JBbGwoJy5saW5lOm5vdCguZHVtbXkpJykpXG4gICAgICAgIHByZUVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnZWRpdG9yLWNvbG9ycycpXG4gICAgICAgIHByZUVsZW1lbnQuaW5uZXJIVE1MID0gaHRtbC5tYXAoKHgpID0+IHguaW5uZXJIVE1MKS5qb2luKCdcXG4nKVxuICAgICAgICBpZiAoZmVuY2VOYW1lKSBwcmVFbGVtZW50LmNsYXNzTGlzdC5hZGQoYGxhbmctJHtmZW5jZU5hbWV9YClcbiAgICAgIH0gZmluYWxseSB7XG4gICAgICAgIGVsLnJlbW92ZSgpXG4gICAgICB9XG4gICAgfSksXG4gIClcblxuICByZXR1cm4gZG9tRnJhZ21lbnRcbn1cblxuYXN5bmMgZnVuY3Rpb24gZWRpdG9yVG9rZW5pemVkKGVkaXRvcjogVGV4dEVkaXRvcikge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICBpZiAoZWRpdG9yLmdldEJ1ZmZlcigpLmdldExhbmd1YWdlTW9kZSgpLmZ1bGx5VG9rZW5pemVkKSB7XG4gICAgICByZXNvbHZlKClcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZGlzcCA9IGVkaXRvci5vbkRpZFRva2VuaXplKCgpID0+IHtcbiAgICAgICAgZGlzcC5kaXNwb3NlKClcbiAgICAgICAgcmVzb2x2ZSgpXG4gICAgICB9KVxuICAgIH1cbiAgfSlcbn1cbiJdfQ==